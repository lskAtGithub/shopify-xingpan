<section class="get-report-section">
  <div class="report-container">
    <div class="bg-gradient-to-br">
      <div class="flex-wrap">
        <!-- å·¦ä¾§å†…å®¹ -->
        <div class="left-content">
          {% if section.settings.heading != blank %}
            <h2>{{ section.settings.heading }}</h2>
          {% endif %}

          {% if section.settings.subheading != blank %}
            <p>{{ section.settings.subheading }}</p>
          {% endif %}

          <div class="note-line">
            <i class="fa fa-star"></i>
            <p>{{ section.settings.note_text }}</p>
          </div>

          {% if section.settings.top_image != blank %}
            <div class="top-img-container">
              <img
                src="{{ section.settings.top_image | image_url: width: 800 }}"
                alt="{{ section.settings.heading }}"
                class="top-img"
                width="800"
                height="{{ section.settings.top_image.height | times: 300 | divided_by: section.settings.top_image.width }}"
              >
            </div>
          {% endif %}
        </div>

        <!-- å³ä¾§è¡¨å• -->
        <div class="form-container">
          <form>
            <div class="form-group">
              <label for="name">Full Name <span class="required">*</span></label>
              <input type="text" id="name" name="name" placeholder="Enter your full name" required value="jack">
            </div>

            <div class="form-group">
              <label>Birth Date & Time <span class="required">*</span></label>
              <div class="grid-cols-3">
                <div>
                  <label for="birth-year">Year</label>
                  <input
                    type="number"
                    id="birth-year"
                    name="birth_year"
                    min="1900"
                    max="2023"
                    placeholder="YYYY"
                    required
                    value="2000"
                  >
                </div>
                <div>
                  <label for="birth-month">Month</label>
                  <select id="birth-month" name="birth_month" required value="1">
                    <option value="">Select</option>
                    {% for m in (1..12) %}
                      <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div>
                  <label for="birth-day">Day</label>
                  <input
                    type="number"
                    id="birth-day"
                    name="birth_day"
                    min="1"
                    max="31"
                    placeholder="DD"
                    required
                    value="1"
                  >
                </div>
              </div>

              <div class="grid-cols-2">
                <div>
                  <label for="birth-hour">Hour (24h)</label>
                  <input
                    type="number"
                    id="birth-hour"
                    name="birth_hour"
                    min="0"
                    max="23"
                    placeholder="HH"
                    required
                    value="1"
                  >
                </div>
                <div>
                  <label for="birth-minute">Minute</label>
                  <input
                    type="number"
                    id="birth-minute"
                    name="birth_minute"
                    min="0"
                    max="59"
                    placeholder="MM"
                    required
                    value="1"
                  >
                </div>
              </div>
            </div>

            <!-- å‡ºç”Ÿåœ°é€‰æ‹©å™¨ -->
            <div class="form-group">
              <label>Birth Location <span class="required">*</span></label>
              <div class="grid-cols-3">
                <div>
                  <label for="country">Country</label>
                  <select id="country" name="country" required>
                    <option value="">Select Country</option>
                  </select>
                </div>
                <div>
                  <label for="state">State/Province</label>
                  <select id="state" name="state" disabled required>
                    <option value="">Select State/Province</option>
                  </select>
                </div>
                <div>
                  <label for="city">City</label>
                  <select id="city" name="city" disabled required>
                    <option value="">Select City</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="daylight-saving" name="daylight_saving">
                <span>Daylight Saving Time was in effect at birth</span>
              </label>
            </div>

            <button id="submit" class="gradient-btn">
              <span>{{ section.settings.button_text }}</span>
              <i class="fa fa-arrow-right"></i>
            </button>
          </form>
        </div>
      </div>

      <!-- ğŸ”¹ å¼¹çª—ç»“æ„ -->
      <div id="report-modal" class="report-modal">
        <div class="report-modal-content">
          <span class="report-close">&times;</span>
          <h2>âœ¨ æŠ¥å‘Šç»“æœ</h2>

          <!-- è¡¨æ ¼ -->
          <table class="table table-hover" id="report-table">
            <thead>
              <tr>
                <th>æ˜Ÿåº§</th>
                <th>è¡Œæ˜Ÿ</th>
                <th>åº™æ—º</th>
                <th>æ˜Ÿåº§å…ƒç´ </th>
                <th>è¡Œæ˜Ÿ-å…ƒç´ åˆ†</th>
                <th>åº™æ—ºå…ƒç´ åˆ†</th>
                <th>è¡Œæ˜Ÿæ‰€è½å®«ä½</th>
                <th>å®«ä½å…ƒç´ </th>
                <th>å®«ä½å…ƒç´ åˆ†</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>

          <!-- ç™¾åˆ†æ¯”åœ†å½¢å›¾ -->
          <div class="canvas-box">
            <div id="tooltip"></div>
            <canvas id="chartCanvas" width="400" height="400" style="width:400px;height:400px;"></canvas>
          </div>
          <!-- æµæ•°æ®æ¸²æŸ“ -->
          <div style="font-size: 16px;color: #BBB;" id="markdownRea" >
            </div>
          <div id="streamData"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let lat = '31.887503';
    let lon = '117.30746';
    let reportId = '';
    document.addEventListener('DOMContentLoaded', function () {
      const countrySelect = document.getElementById('country');
      const stateSelect = document.getElementById('state');
      const citySelect = document.getElementById('city');
      const API_URL = 'https://nacos.heartbuy.cn/city/getInfo';

      const PLACEHOLDERS = {
        country: 'Select Country',
        state: 'Select State/Province',
        city: 'Select City',
      };

      function createOption(text, value = '') {
        const opt = document.createElement('option');
        opt.value = value;
        opt.textContent = text;
        return opt;
      }

      function resetSelect(select, placeholder) {
        select.innerHTML = '';
        select.appendChild(createOption(placeholder, ''));
        select.disabled = true;
      }

      function setLoading(select) {
        select.innerHTML = '';
        select.appendChild(createOption('Loading...', ''));
        select.disabled = true;
      }

      function populateSelectWithObjects(select, items, textKey = 'name', valueKey = 'id') {
        select.innerHTML = '';
        select.appendChild(
          createOption(
            select === countrySelect
              ? PLACEHOLDERS.country
              : select === stateSelect
              ? PLACEHOLDERS.state
              : PLACEHOLDERS.city,
            ''
          )
        );
        if (!items || !items.length) {
          select.disabled = true;
          return;
        }
        items.forEach((item) => {
          const text = (item && (item[textKey] || item.name || String(item))) || '';
          const value =
            (item && (item[valueKey] !== undefined ? item[valueKey] : item.id !== undefined ? item.id : item)) || '';
          const opt = createOption(text, value);
          select.appendChild(opt);
          opt.dataset.latitude = item.latitude;
          opt.dataset.longitude = item.longitude;
        });
        select.disabled = false;
      }

      async function fetchFromApi(params = {}) {
        // æ„é€ å¸¦æŸ¥è¯¢ä¸²çš„ URL
        const url = new URL(API_URL);
        Object.keys(params).forEach((k) => {
          if (params[k] !== undefined && params[k] !== null && params[k] !== '') url.searchParams.append(k, params[k]);
        });

        try {
          const res = await fetch(url.toString(), { method: 'GET', mode: 'cors' });
          if (!res.ok) {
            throw new Error('HTTP ' + res.status);
          }
          const json = await res.json();
          // å…¼å®¹ï¼šè¿”å›åŒ…è£¹ { code, message, data: [...] } çš„æƒ…å½¢
          if (json && Array.isArray(json.data)) {
            return json.data;
          }
          // æœ‰äº›æ¥å£å¯èƒ½ç›´æ¥è¿”å›æ•°ç»„
          if (Array.isArray(json)) {
            return json;
          }
          // å…œåº•è¿”å›ç©ºæ•°ç»„
          return [];
        } catch (err) {
          return [];
        }
      }

      // åˆå§‹åŒ–ï¼šæ¸…ç©ºä¸‹çº§
      resetSelect(stateSelect, PLACEHOLDERS.state);
      resetSelect(citySelect, PLACEHOLDERS.city);

      // åŠ è½½å›½å®¶åˆ—è¡¨ï¼ˆé¡µé¢åŠ è½½æ—¶ï¼‰
      (async function loadCountries() {
        setLoading(countrySelect);
        const countries = await fetchFromApi(); // ä¸ä¼ å‚æ•° => è¿”å›å›½å®¶åˆ—è¡¨ï¼ˆä½ ç»™çš„ç¤ºä¾‹å³ä¸ºæ­¤ï¼‰
        populateSelectWithObjects(countrySelect, countries, 'name', 'id');
      })();

      // å½“å›½å®¶æ”¹å˜æ—¶ï¼ŒåŠ è½½å·/çœ
      countrySelect.addEventListener('change', async function () {
        const countryId = this.value;
        // æ¸…ç©ºå·å’Œå¸‚
        resetSelect(stateSelect, PLACEHOLDERS.state);
        resetSelect(citySelect, PLACEHOLDERS.city);
        if (!countryId) return;

        setLoading(stateSelect);
        const states = await fetchFromApi({ countryId: countryId });
        populateSelectWithObjects(stateSelect, states, 'name', 'id');
      });

      // å½“å·/çœæ”¹å˜æ—¶ï¼ŒåŠ è½½åŸå¸‚
      stateSelect.addEventListener('change', async function () {
        const stateId = this.value;
        const countryId = countrySelect.value;
        resetSelect(citySelect, PLACEHOLDERS.city);
        if (!countryId || !stateId) return;

        setLoading(citySelect);
        const cities = await fetchFromApi({ countryId: '', stateId: stateId });
        populateSelectWithObjects(citySelect, cities, 'name', 'id');
      });
      citySelect.addEventListener('change', async function () {
        const opt = this.options[this.selectedIndex];
        lat = opt.dataset.latitude;
        lon = opt.dataset.longitude;
      });
      //  æäº¤è¡¨å•
      const form = document.querySelector('form');
      form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const name = document.getElementById('name').value.trim();
        const year = document.getElementById('birth-year').value;
        const month = document.getElementById('birth-month').value;
        const day = document.getElementById('birth-day').value;
        const hour = document.getElementById('birth-hour').value;
        const minute = document.getElementById('birth-minute').value;
        const country = document.getElementById('country').value;
        const state = document.getElementById('state').value;
        const city = document.getElementById('city').value;
        const time = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')} ${String(hour).padStart(
          2,
          '0'
        )}:${String(minute).padStart(2, '0')}:00`;

        const address = `${country} ${state} ${city}`;
        const payload = {
          time: time,
          lat: lat,
          lon: lon,
          name: name,
          address: address,
          ztime: 8,
          tid: 4,
        };
        const query = new URLSearchParams(payload).toString();
        const url = 'https://nacos.heartbuy.cn/astrology/astrology?' + query;

        try {
          const res = await fetch(url);
          const data = await res.json();
          console.log('è¿”å›ç»“æœï¼š', data);
          reportId = data.data.reportId;
          renderModal(data.data);
          loadStream();
        } catch (err) {
          alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        }
        return false;
      });

      const modal = document.getElementById('report-modal');
      const closeBtn = document.querySelector('.report-close');
      const tableBody = document.querySelector('#report-table tbody');

      function loadStream() {
        const streamData = document.getElementById('streamData');
        const markdownRea = document.getElementById('markdownRea');

        const eventSource = new EventSource(`/astrology/doubao?id=4&reportId=${reportId}`);
        var content = '';
        var reason = '';
        eventSource.onmessage = function (eventStream) {
          try {
            var json = JSON.parse(eventStream.data);
            var choices = json.choices;
            for (var i = 0; i < choices.length; i++) {
              var item = choices[i].delta;
              if (item.content != undefined && item.content != '') {
                content += item.content;
                streamData.innerHTML = marked.parse(content);
              }

              if (item.reasoning_content != undefined && item.reasoning_content != '') {
                reason += item.reasoning_content;
                markdownRea.innerHTML = marked.parse(reason);
              }
              that.scrollToBottom();
            }
          } catch (e) {}
        };

        eventSource.onerror = function (error) {
          eventSource.close();
        };
      }

      function renderCanvas(res) {
        const data = res.itemScore;
        const baseColors = ['#059bff', '#ff6384', '#ff9f40', '#ffcd56']; // åŸå§‹é¢œè‰²

        const canvas = document.getElementById('chartCanvas');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('tooltip');

        const total = Object.values(data).reduce((a, b) => a + b, 0);
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(canvas.width, canvas.height) * 0.35;

        const gap = 1 / radius;

        let slices = [];

        // æäº®é¢œè‰²å‡½æ•°
        function lightenColor(hex, percent) {
          let num = parseInt(hex.replace('#', ''), 16),
            r = (num >> 16) + Math.round(2.55 * percent),
            g = ((num >> 8) & 0x00ff) + Math.round(2.55 * percent),
            b = (num & 0x0000ff) + Math.round(2.55 * percent);

          return (
            '#' +
            (
              0x1000000 +
              (r < 255 ? (r < 0 ? 0 : r) : 255) * 0x10000 +
              (g < 255 ? (g < 0 ? 0 : g) : 255) * 0x100 +
              (b < 255 ? (b < 0 ? 0 : b) : 255)
            )
              .toString(16)
              .slice(1)
          );
        }

        function draw(highlightIndex = -1) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          let startAngle = -Math.PI / 2;
          let i = 0;
          slices = [];

          for (let key in data) {
            const value = data[key];
            const sliceAngle = (value / total) * 2 * Math.PI;

            const adjustedStart = startAngle + gap / 2;
            const adjustedEnd = startAngle + sliceAngle - gap / 2;

            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.arc(centerX, centerY, radius, adjustedStart, adjustedEnd);
            ctx.closePath();

            const baseColor = baseColors[i % baseColors.length];
            ctx.fillStyle = i === highlightIndex ? lightenColor(baseColor, 10) : baseColor;
            ctx.fill();

            slices.push({
              label: key,
              value,
              startAngle: adjustedStart,
              endAngle: adjustedEnd,
              color: ctx.fillStyle,
              centerX,
              centerY,
              radius,
            });

            startAngle += sliceAngle;
            i++;
          }
        }

        draw();

        function angleInSegment(x, y, slice) {
          const dx = x - slice.centerX;
          const dy = y - slice.centerY;
          const distance = Math.sqrt(dx * dx + dy * dy);

          if (distance > slice.radius) return false; // åœ¨åœ†å¤–

          let angle = Math.atan2(dy, dx);
          if (angle < -Math.PI / 2) angle += 2 * Math.PI; // ä¿®æ­£è§’åº¦

          return angle >= slice.startAngle && angle <= slice.endAngle;
        }

        canvas.addEventListener('mousemove', function (e) {
          let foundIndex = -1;
          slices.forEach((slice, index) => {
            if (angleInSegment(e.offsetX, e.offsetY, slice)) {
              foundIndex = index;
              tooltip.style.left = e.offsetX + 12 + 'px';
              tooltip.style.top = e.offsetY + 'px';
              tooltip.innerHTML = `<strong style="margin-right:6px">${slice.label}</strong> ${slice.value}`;
              tooltip.style.display = 'block';
            }
          });

          if (foundIndex !== -1) {
            draw(foundIndex); // é«˜äº®
          } else {
            draw(); // æ¢å¤
            tooltip.style.display = 'none';
          }
        });

        canvas.addEventListener('mouseleave', function () {
          draw();
          tooltip.style.display = 'none';
        });
        loadStream();
      }

      async function renderModal(data) {
        modal.style.display = 'flex';
        tableBody.innerHTML = '';
        if (data.list.length > 0) {
          data.list.forEach((item, index) => {
            const miaoWang =
              item.miao === 0 && item.wang === 0
                ? 'æ— '
                : (item.miao > 0 ? 'åº™' : '') +
                  (item.miao > 0 && item.wang > 0 ? '/' : '') +
                  (item.wang > 0 ? 'æ—º' : '');

            const row = `
          <tr class="${index % 2 === 1 ? 'even-row' : ''}">
            <td>${item.constellationCN}</td>
            <td>${item.starNameCN}</td>
            <td>${miaoWang}</td>
            <td>${item.zodiacSigns}</td>
            <td>${item.starScore}</td>
            <td>${item.miao + item.wang}</td>
            <td>${item.houses ? item.houses : '/'}</td>
            <td>${item.houses ? item.housesName : '/'}</td>
            <td>${item.houses ? item.housesScore : '/'}</td>
          </tr>`;
            tableBody.insertAdjacentHTML('beforeend', row);
          });
        } else {
          tableBody.innerHTML = `
        <tr>
          <td colspan="9" style="text-align: center; color: #999;">
            æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®
          </td>
        </tr>`;
        }
        renderCanvas(data);
      }

      // å…³é—­å¼¹çª—
      closeBtn.addEventListener('click', function () {
        modal.style.display = 'none';
      });
      window.addEventListener('click', function (e) {
        if (e.target === modal) modal.style.display = 'none';
      });
    });
  </script>

  {% schema %}
{
  "name": "Get Report Section",
  "settings": [
    { "type": "text", "id": "heading", "label": "æ ‡é¢˜", "default": "Discover Your Elemental Energy" },
    {
      "type": "textarea",
      "id": "subheading",
      "label": "å‰¯æ ‡é¢˜/æè¿°",
      "default": "Uncover your strongest & weakest elementsâ€”find your perfect crystal art to balance your energy."
    },
    {
      "type": "text",
      "id": "note_text",
      "label": "æç¤ºæ–‡å­—",
      "default": "Free personalized report for first-time visitors"
    },
    { "type": "image_picker", "id": "top_image", "label": "é¡¶éƒ¨å›¾ç‰‡" },
    { "type": "text", "id": "button_text", "label": "æŒ‰é’®æ–‡å­—", "default": "Get Your Free Mini Report" }
  ],
  "presets": [{ "name": "Get Report Section", "category": "Custom" }]
}
  {% endschema %}
</section>
